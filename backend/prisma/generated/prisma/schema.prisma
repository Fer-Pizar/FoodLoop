generator client {
  provider = "prisma-client-js"
  output   = "./generated/prisma"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model categorias {
  id_categoria BigInt      @id @default(autoincrement())
  nombre       String      @db.VarChar(50)
  descripcion  String?
  updated_at   DateTime    @default(now()) @db.Timestamptz(6)
  productos    productos[]
}

model comercios {
  id_comercio    BigInt      @id @default(autoincrement())
  id_usuario     BigInt
  nombre_negocio String      @db.VarChar(100)
  telefono       String?     @db.VarChar(20)
  direccion      String?     @db.VarChar(200)
  latitud        Decimal?    @db.Decimal(9, 6)
  longitud       Decimal?    @db.Decimal(9, 6)
  categoria      String?     @db.VarChar(50)
  fecha_registro DateTime    @default(now()) @db.Timestamptz(6)
  estado         Boolean     @default(true)
  updated_at     DateTime    @default(now()) @db.Timestamptz(6)
  usuarios       usuarios    @relation(fields: [id_usuario], references: [id_usuario], onDelete: Cascade, onUpdate: NoAction)
  productos      productos[]

  @@index([id_usuario], map: "idx_comercios_id_usuario")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model notificaciones {
  id_notificacion BigInt   @id @default(autoincrement())
  id_usuario      BigInt
  titulo          String?  @db.VarChar(100)
  mensaje         String?
  tipo            String?  @db.VarChar(20)
  fecha_envio     DateTime @default(now()) @db.Timestamptz(6)
  leido           Boolean  @default(false)
  updated_at      DateTime @default(now()) @db.Timestamptz(6)
  usuarios        usuarios @relation(fields: [id_usuario], references: [id_usuario], onDelete: Cascade, onUpdate: NoAction)
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model productos {
  id_producto         BigInt     @id @default(autoincrement())
  id_comercio         BigInt
  id_categoria        BigInt
  nombre              String     @db.VarChar(100)
  descripcion         String?
  precio_base         Decimal    @db.Decimal(10, 2)
  precio_actual       Decimal?   @db.Decimal(10, 2)
  fecha_vencimiento   DateTime?  @db.Date
  cantidad_disponible Int?
  imagen_url          String?
  fecha_publicacion   DateTime   @default(now()) @db.Timestamptz(6)
  estado              Boolean    @default(true)
  updated_at          DateTime   @default(now()) @db.Timestamptz(6)
  categorias          categorias @relation(fields: [id_categoria], references: [id_categoria], onDelete: NoAction, onUpdate: NoAction)
  comercios           comercios  @relation(fields: [id_comercio], references: [id_comercio], onDelete: Cascade, onUpdate: NoAction)
  reservas            reservas[]

  @@index([estado, fecha_publicacion(sort: Desc)], map: "idx_productos_estado_fecha_pub")
  @@index([fecha_vencimiento], map: "idx_productos_fecha_venc")
  @@index([id_categoria], map: "idx_productos_id_categoria")
  @@index([id_comercio], map: "idx_productos_id_comercio")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model reservas {
  id_reserva            BigInt         @id @default(autoincrement())
  id_usuario            BigInt
  id_producto           BigInt
  cantidad              Int
  total                 Decimal        @db.Decimal(10, 2)
  codigo_validacion     String         @unique @db.VarChar(12)
  estado                reserva_estado @default(pendiente)
  fecha_reserva         DateTime       @default(now()) @db.Timestamptz(6)
  ventana_retiro_inicio DateTime?      @db.Timestamptz(6)
  ventana_retiro_fin    DateTime?      @db.Timestamptz(6)
  updated_at            DateTime       @default(now()) @db.Timestamptz(6)
  productos             productos      @relation(fields: [id_producto], references: [id_producto], onDelete: Cascade, onUpdate: NoAction)
  usuarios              usuarios       @relation(fields: [id_usuario], references: [id_usuario], onDelete: Cascade, onUpdate: NoAction)

  @@index([id_producto], map: "idx_reservas_id_producto")
  @@index([id_usuario], map: "idx_reservas_id_usuario")
}

model usuarios {
  id_usuario       BigInt           @id @default(autoincrement())
  nombre           String           @db.VarChar(100)
  email            String           @unique @db.VarChar(100)
  contrasena_hash  String
  fecha_nacimiento DateTime?        @db.Date
  foto_perfil      String?
  fecha_registro   DateTime         @default(now()) @db.Timestamptz(6)
  estado           Boolean          @default(true)
  updated_at       DateTime         @default(now()) @db.Timestamptz(6)
  comercios        comercios[]
  notificaciones   notificaciones[]
  reservas         reservas[]
}

enum reserva_estado {
  pendiente
  confirmada
  cancelada
  entregada
}
